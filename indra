#!/bin/bash
# IndrasNetwork simulation launcher
# Usage: ./indra <scenario_name> [options]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCENARIOS_DIR="$SCRIPT_DIR/simulation/scripts/scenarios"

# Show help
show_help() {
    echo "IndrasNetwork Simulation Launcher"
    echo ""
    echo "Usage: ./indra <scenario> [options]"
    echo ""
    echo "Scenarios:"
    echo "  abc           A-B-C relay scenario (canonical example)"
    echo "  chaos         Random chaos monkey testing"
    echo "  relay         Multi-hop relay chain"
    echo "  test          Comprehensive test suite"
    echo ""
    echo "Options:"
    echo "  --pretty      Use human-readable output instead of JSONL"
    echo "  --level LVL   Set log level (trace, debug, info, warn, error)"
    echo "  --list        List all available scenarios"
    echo "  --help        Show this help"
    echo ""
    echo "Examples:"
    echo "  ./indra abc"
    echo "  ./indra chaos --pretty"
    echo "  ./indra relay --level debug"
}

# List scenarios
list_scenarios() {
    echo "Available scenarios:"
    echo ""
    for f in "$SCENARIOS_DIR"/*.lua; do
        if [ -f "$f" ]; then
            name=$(basename "$f" .lua)
            # Extract first comment line as description
            desc=$(head -3 "$f" | grep -E "^--" | head -1 | sed 's/^-- *//')
            printf "  %-20s %s\n" "$name" "$desc"
        fi
    done
}

# Map short names to full paths
get_scenario_path() {
    case "$1" in
        abc)        echo "$SCENARIOS_DIR/abc_relay.lua" ;;
        chaos)      echo "$SCENARIOS_DIR/chaos_monkey.lua" ;;
        relay)      echo "$SCENARIOS_DIR/relay_chain.lua" ;;
        test)       echo "$SCENARIOS_DIR/comprehensive_test.lua" ;;
        *)
            # Try direct match
            if [ -f "$SCENARIOS_DIR/$1.lua" ]; then
                echo "$SCENARIOS_DIR/$1.lua"
            elif [ -f "$SCENARIOS_DIR/${1}_*.lua" ]; then
                echo "$SCENARIOS_DIR/${1}_*.lua"
            elif [ -f "$1" ]; then
                echo "$1"
            else
                echo ""
            fi
            ;;
    esac
}

# Parse arguments
if [ $# -eq 0 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

if [ "$1" = "--list" ]; then
    list_scenarios
    exit 0
fi

SCENARIO="$1"
shift

# Get scenario path
SCENARIO_PATH=$(get_scenario_path "$SCENARIO")

if [ -z "$SCENARIO_PATH" ] || [ ! -f "$SCENARIO_PATH" ]; then
    echo "Error: Unknown scenario '$SCENARIO'"
    echo ""
    echo "Run './indra --list' to see available scenarios"
    exit 1
fi

# Build if needed (quick check)
if [ ! -f "$SCRIPT_DIR/target/debug/lua_runner" ]; then
    echo "Building lua_runner..."
    cargo build --bin lua_runner --manifest-path "$SCRIPT_DIR/simulation/Cargo.toml"
fi

# Run the scenario
cargo run --bin lua_runner --manifest-path "$SCRIPT_DIR/simulation/Cargo.toml" -- "$SCENARIO_PATH" "$@"
EXIT_CODE=$?

# Get the log file name (matches the script name)
SCRIPT_NAME=$(basename "$SCENARIO_PATH" .lua)
LOG_FILE="$SCRIPT_DIR/logs/${SCRIPT_NAME}.log"

# Convert JSONL to markdown summary
if [ -f "$LOG_FILE" ] && command -v jq &> /dev/null; then
    LOGS_MD="$SCRIPT_DIR/LOGS.md"

    # Extract summary stats from the log
    TOTAL_ENTRIES=$(wc -l < "$LOG_FILE" | tr -d ' ')
    ERROR_COUNT=$(jq -s '[.[] | select(.level == "ERROR")] | length' "$LOG_FILE" 2>/dev/null || echo 0)
    WARN_COUNT=$(jq -s '[.[] | select(.level == "WARN")] | length' "$LOG_FILE" 2>/dev/null || echo 0)

    {
        echo "# Simulation Log: $SCRIPT_NAME"
        echo ""
        echo "| | |"
        echo "|---|---|"
        echo "| **Scenario** | $SCRIPT_NAME |"
        echo "| **Generated** | $(date '+%Y-%m-%d %H:%M:%S') |"
        echo "| **Log Entries** | $TOTAL_ENTRIES |"
        if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "| **Errors** | $ERROR_COUNT |"
        fi
        if [ "$WARN_COUNT" -gt 0 ]; then
            echo "| **Warnings** | $WARN_COUNT |"
        fi
        echo ""
        echo "---"
        echo ""
        echo "## Events"
        echo ""

        # Process each log entry
        jq -r '
            def level_icon:
                if .level == "ERROR" then "âŒ"
                elif .level == "WARN" then "âš ï¸"
                elif .level == "INFO" then "â†’"
                elif .level == "DEBUG" then "Â·"
                else " "
                end;

            def format_fields:
                if .fields then
                    (.fields | fromjson? // .fields) as $f |
                    if $f | type == "object" then
                        " " + ($f | to_entries | map("`\(.key)=\(.value)`") | join(" "))
                    else ""
                    end
                else ""
                end;

            def format_location:
                if .level == "ERROR" or .level == "WARN" then
                    "\n   â””â”€ " + .target + " (" + .filename + ":" + (.line_number | tostring) + ")"
                else ""
                end;

            "\(level_icon) \(.message)\(format_fields)\(format_location)"
        ' "$LOG_FILE" 2>/dev/null

        echo ""
        echo "---"
        echo ""
        echo "*Source: \`logs/$SCRIPT_NAME.log\`*"
    } > "$LOGS_MD"

    echo ""
    echo "ðŸ“„ Log summary written to LOGS.md"
fi

exit $EXIT_CODE
